---
title: "Annotate samples using NBAtlas reference"
author: "Stephanie J. Spielman"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_depth: 3
    code_folding: hide
---

We have used `SingleR` and `scANVI/scArches` to perform cell type annotation on `SCPCP000004` samples using the NBAtlas reference.
The goal of this notebook is to derive annotations for these samples using information from these annotations as well as consensus cell type annotations.

   
## Setup

```{r, warning = FALSE}
suppressPackageStartupMessages({
  library(ggplot2)
  library(patchwork)
  library(SingleCellExperiment)
})

theme_set(theme_bw())

# Define color ramp for shared use in the heatmaps
heatmap_col_fun <- circlize::colorRamp2(c(0, 1), colors = c("white", "darkslateblue"))
# Set heatmap padding option
ComplexHeatmap::ht_opt(TITLE_PADDING = grid::unit(0.6, "in"))

# settings
options(
  dplyr.summarise.inform = FALSE, 
  readr.show_col_types = FALSE
)
```


### Paths

```{r base paths}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
repository_base <- rprojroot::find_root(rprojroot::is_git_root)

merged_dir <- file.path(repository_base, "data", "current", "results", "merge-sce", "SCPCP000004")
module_dir <- file.path(repository_base, "analyses", "cell-type-neuroblastoma-04")
ref_dir <- file.path(module_dir, "references")
results_dir <- file.path(module_dir, "results")
singler_dir <- file.path(results_dir, "singler")
scanvi_dir <- file.path(results_dir, "scanvi")
```


```{r file paths}
# merged SCE file
sce_file <- file.path(
  merged_dir,
  "SCPCP000004_merged.rds"
)

# SingleR files
singler_files <- list.files(
  path = singler_dir,
  pattern = "_singler-annotations\\.tsv",
  recursive = TRUE,
  full.names = TRUE
) |>
  # add names as library id
  purrr::set_names(
    \(x) {
      stringr::str_remove(basename(x), "_singler-annotations.tsv")
    }
  )

# scanvi predictions
scanvi_file <- file.path(
  scanvi_dir, 
  "scanvi-predictions.tsv"
)


# broad consensus cell type groups
validation_url <- "https://raw.githubusercontent.com/AlexsLemonade/OpenScPCA-analysis/refs/heads/main/analyses/cell-type-consensus/references/consensus-validation-groups.tsv"

# palette files
recoded_palette_file <- file.path(
  module_dir,
  "palettes",
  "harmonized-cell-type-palette.tsv"
)

nbatlas_palette_file <- file.path(
  module_dir,
  "palettes",
  "nbatlas-marker-genes-palette.tsv"
)

# marker genes for validation
consensus_markers_file <- "https://raw.githubusercontent.com/AlexsLemonade/OpenScPCA-analysis/refs/heads/main/analyses/cell-type-consensus/references/validation-markers.tsv"
nbatlas_markers_file <- file.path(ref_dir, "nbatlas-marker-genes.tsv")
```

### Functions

```{r}
# Source Jaccard and heatmap utilities functions
source(file.path(module_dir, "scripts", "utils", "jaccard-utils.R"))

# Source additional utilities functions:
# - select_nbatlas_markers()
# - harmonize_celltypes()
# - faceted_umap()
# - generate_dotplot()
source(file.path(module_dir, "scripts", "utils", "celltype-utils.R"))
```

### Read and prepare input data

Read merged SCE object:

```{r}
merged_sce <- readRDS(sce_file)
# immediately remove assays we don't need for space
assay(merged_sce, "spliced") <- NULL
assay(merged_sce, "counts") <- NULL
reducedDim(merged_sce, "PCA") <- NULL
```

Read SingleR results:

```{r}
singler_df <- singler_files |>
  purrr::map(readr::read_tsv) |>
  purrr::list_rbind(names_to = "library_id") |>
  dplyr::mutate(
    # add cell id column for unique rows & joining
    cell_id = glue::glue("{library_id}-{barcodes}"),
    # recode NA -> "unknown_singler"
    singler = ifelse(is.na(pruned.labels),"unknown_singler", pruned.labels)
  ) |>
  dplyr::select(cell_id, singler, singler_delta_next = delta.next)
```

Read and prepare scanvi results:

```{r}
scanvi_full_df <- readr::read_tsv(
  file.path(scanvi_dir, "scanvi_predictions.tsv")
) |>
  dplyr::select(
    cell_id, 
    scanvi = scanvi_prediction, 
    starts_with("pp_")
  ) |>
  tidyr::pivot_longer(
    starts_with("pp_"), 
    names_to = "posterior_celltype", 
    values_to = "posterior"
  ) |>
  dplyr::mutate(posterior_celltype = stringr::str_remove(posterior_celltype, "^pp_"))

# create dedicated column for the posterior associated with the label
scanvi_df <- scanvi_full_df |>
  dplyr::filter(scanvi == posterior_celltype) |>
  dplyr::select(cell_id, scanvi, scanvi_posterior = posterior)
```


Read and prepare additional helper files for viz:

```{r}
# validation data frames
validation_df <- readr::read_tsv(validation_url) |>
  dplyr::select(consensus_annotation, validation_group_annotation)
consensus_markers_df <- readr::read_tsv(consensus_markers_file)
nbatlas_markers_df <- readr::read_tsv(nbatlas_markers_file)


# set up palettes
# recoded to shared colors
recoded_palette_df <- readr::read_tsv(recoded_palette_file)
recoded_celltype_pal <- recoded_palette_df$hex_color
names(recoded_celltype_pal) <- recoded_palette_df$harmonized_label
```


## Posteriors

Before we dive into annotation, we should get a sense of reliability for the scANVI results.

First, what is the distribution of posterior probabilities?
We'll look at this on a per-library basis to see if there's any bias.


```{r fig.height=12, fig.width=15}
scanvi_df |>
  tidyr::separate(cell_id, into = c("library_id", "barcode"), remove = FALSE) |>
  dplyr::add_count(library_id) |>
  dplyr::mutate(library_id = glue::glue("{library_id} (N={n})")) |>
  ############ into ggplot ################
  ggplot() + 
  aes(x = scanvi_posterior) + 
  # ugly but _very visible_ color
  geom_histogram(bins = 100, fill = "magenta", color = "magenta") + 
  facet_wrap(vars(library_id), scales = "free_y", ncol = 7) 

```


The posterior probabilities here are all _exceptionally_ high, consistently across all libraries.

Let's instead look at this on a per-cell type basis:

```{r fig.height=8, fig.width=12}
ggplot(scanvi_df) + 
  aes(x = scanvi_posterior) + 
  # ugly but _very visible_ color
  geom_histogram(bins = 100, fill = "magenta", color = "magenta") + 
  facet_wrap(vars(scanvi), scales = "free_y", ncol = 5) 
```

While annotation reliability is about the same on a per-library basis, it seems that certain cell types may be much easier to classify than others which may be a factor of how well represented they are in the `NBAtlas` reference.
We'll look at the median value for each as well as the number of cells that were annotated for each label:

```{r}
scanvi_df |>
  dplyr::group_by(scanvi) |>
  dplyr::summarize(
    median_pp = median(scanvi_posterior), 
    total_cells = dplyr::n()
  ) |>
  dplyr::arrange(median_pp)
```

There are very few cells in general associated with the cell types that have very low median posterior probabilities (`NKT cell` and `Migratory cDC`), which is comforting.

A `0.9` threshold for the posterior probability here seems reasonable given how high these values are in general. 
Let's set these to `unknown_scanvi`:

```{r}
pp_threshold <- 0.9
scanvi_df <- scanvi_df |>
  dplyr::mutate(scanvi = ifelse(
    scanvi_posterior < pp_threshold, 
    "unknown_scanvi",
    scanvi
  ))
```

## Let's go!

Create a single data frame with UMAP coordinates and all cell types:

```{r}
celltype_full_df <- scuttle::makePerCellDF(
  merged_sce,
  use.coldata = c("sample_id", "consensus_celltype_annotation"),
  use.dimred = c("UMAP")
) |>
  # there ARE repeated barcodes so we need to keep cell_id around
  tibble::rownames_to_column("cell_id") |>
  dplyr::rename(
    UMAP1 = UMAP.1,
    UMAP2 = UMAP.2,
    consensus_annotation = consensus_celltype_annotation
  ) |>
  dplyr::left_join(validation_df, by = "consensus_annotation") |>
  # recode consensus NAs to "unknown_consensus"
  dplyr::mutate(
    validation_group_annotation = ifelse(
      is.na(validation_group_annotation), "unknown_consensus", validation_group_annotation
    ),
    consensus_annotation = ifelse(
      is.na(consensus_annotation), "unknown_consensus", consensus_annotation
    )
  ) |>
  # only bring in the annotations, not the delta_next/posteriors
  dplyr::left_join(
    dplyr::select(singler_df, cell_id, singler), by = "cell_id"
  ) |>
  dplyr::left_join(
    dplyr::select(scanvi_df, cell_id, scanvi), by = "cell_id"
  ) |>
  # make it tidy
  tidyr::pivot_longer(
    c(validation_group_annotation, consensus_annotation, singler, scanvi), 
    names_to = "celltype_method", 
    values_to = "label"
  ) |>
  # note that the `consensus_annotation` values won't necessarily get harmonized
  harmonize_celltypes(label, label_recoded)

# we dont want this column for viz even though we do want it for annotation in the end
celltype_df <- celltype_full_df |>
  dplyr::filter(celltype_method != "consensus_annotation")
```


## UMAPs

### Merged object heatmap

```{r, fig.width = 12, fig.height = 8}
ggplot(celltype_df) +
  aes(x = UMAP1, y = UMAP2, color = label_recoded) +
  geom_point(alpha = 0.5, size = 0.2) +
  scale_color_manual(values = recoded_celltype_pal) +
  facet_wrap(vars(celltype_method)) +
  coord_equal() +
  theme(
    legend.position = "bottom", 
    axis.text = element_blank(), 
    axis.ticks = element_blank()
  ) +
  guides(color = guide_legend(override.aes = list(size = 2, alpha = 1)))
```


## Heatmap

Below we show a stacked heatmap comparing the SingleR and scANVI annotations to broad consensus groups.


```{r, fig.height = 13, fig.width = 12} 
# make a wide version for the heatmap
celltype_wide_df <- celltype_df |>
  dplyr::select(-label) |>
  tidyr::pivot_wider(
    names_from = celltype_method,
    values_from = label_recoded
  )

list(
  "singler" = make_jaccard_matrix(celltype_wide_df, "validation_group_annotation", "singler"),
  "scanvi" = make_jaccard_matrix(celltype_wide_df, "validation_group_annotation", "scanvi")
) |>
  purrr::imap(
    \(jaccard_mat, name) create_single_heatmap(
        mat = jaccard_mat,
        row_title = name,
        column_title = "Consensus validation groups",
        keep_legend_name = "singler" # arbitrary
    )
  ) |>
  # concatenate vertically into HeatmapList object
  purrr::reduce(ComplexHeatmap::`%v%`) |>
  ComplexHeatmap::draw(heatmap_legend_side = "right")
```



## Annotation time and refinement

We'll define some cell type groups which will be useful for annotation.
This is a placeholder.
```{r}
match_df <- readr::read_tsv("~/Desktop/matching.tsv") |>
  tidyr::separate_rows(
    consensus_labels, sep = "; "
  ) |>
  dplyr::rename(consensus = consensus_labels)
```

```{r}
nbatlas_t_celltypes <- c("CD4+ T cell", "CD8+ T cell", "NKT cell", "Treg")
nbatlas_nk_celltypes <- c("Circulating NK cell", "Resident NK cell", "TOX2+/KIT+ NK cell")
nbatlas_dend_celltypes <- c("pDC", "cDC1", "cDC2/DC3", "Migratory cDC")
nbatlas_mono_celltypes <- c("Classical monocyte", "Patrolling monocyte")
nbatlas_monophago_celltypes <- c("cDC1", "cDC2/DC3", "Migratory cDC", nbatlas_mono_celltypes, "Macrophage") # NOT pDC!
nbatlas_myeloid_leuko_celltypes <- c(nbatlas_monophago_celltypes, "Neutrophil")

consensus_t_celltypes <- c(
  "mature alpha-beta T cell", 
  "mature T cell", 
  "memory T cell", 
  "regulatory T cell", 
  "T cell"
)

consensus_monophago_celltypes <- c(
  "mononuclear phagocyte",
  "monocyte",
  "macrophage",
  "dendritic cell"
)

consensus_myeloid_leuko_celltypes <- c(
  "myeloid leukocyte",
  "neutrophil",
  consensus_monophago_celltypes
)
consensus_b_celltypes <- c(
  "naive B cell", 
  "mature B cell", 
  "memory B cell", 
  "B cell"
)

consensus_b_lineage <- c(
  "lymphocyte of B lineage", 
  "plasma cell", 
  consensus_b_celltypes
)

consensus_endothelial_celltypes <- c(
  "endothelial cell",
  "blood vessel endothelial cell",
  "pericyte"
)
```


### Scenario 1: All three labels agree


```{r}
# add columns for joining only
match_join_df <- match_df |>
  dplyr::mutate(scanvi = NBAtlas_label, singler = NBAtlas_label) |>
  dplyr::select(-NBAtlas_label)
```

Here we're getting adding in `final_label` for the _exact_ matches.
This also establishes `annotation_df`; `NA`s in the `final_label` column don't have labels yet.

```{r}
celltype_annotate_df <- celltype_full_df |>
  dplyr::filter(celltype_method != "validation_group_annotation") |>
  dplyr::select(cell_id, celltype_method, label) |>
  # collapse all the unknowns to Unknown
  dplyr::mutate(
    label = ifelse(stringr::str_detect(label, "unknown"), "Unknown", label)
  ) |>
  tidyr::pivot_wider(
    names_from = celltype_method,
    values_from = label
  ) |>
  dplyr::rename(consensus = consensus_annotation)


annotation_df <- celltype_annotate_df |>
  dplyr::left_join(
    match_join_df, by = c("consensus", "scanvi", "singler")
  ) 
```


### Scenario 2: Labels do not exactly agree but are in the same family

```{r}
annotation_df <- annotation_df |>
  dplyr::mutate(
    # make sure not to overwrite an existing label!
    final_label = dplyr::case_when(
      is.na(final_label) & singler %in% nbatlas_t_celltypes & scanvi %in% nbatlas_t_celltypes & consensus %in% consensus_t_celltypes ~ "T cell",
      # these next two broaden
      is.na(final_label) & singler == "B cell" & scanvi == "B cell" & consensus %in% consensus_b_celltypes ~ "B cell",
      is.na(final_label) & singler == "B cell" & scanvi == "B cell" & consensus %in% consensus_b_lineage ~ "lymphocyte of B lineage",
      is.na(final_label) & singler %in% nbatlas_nk_celltypes & scanvi %in% nbatlas_nk_celltypes & consensus == "natural killer cell" ~ "natural killer cell",
      is.na(final_label) & singler %in% nbatlas_dend_celltypes & scanvi %in% nbatlas_dend_celltypes & consensus == "dendritic cell" ~ "dendritic cell",
      is.na(final_label) & singler %in% nbatlas_mono_celltypes & scanvi %in% nbatlas_mono_celltypes & consensus == "monocyte" ~ "monocyte",
      # these next two broaden
      is.na(final_label) & singler %in% nbatlas_monophago_celltypes & scanvi %in% nbatlas_monophago_celltypes & consensus %in% consensus_monophago_celltypes ~ "mononuclear phagocyte",
      is.na(final_label) & singler %in% nbatlas_myeloid_leuko_celltypes & scanvi %in% nbatlas_myeloid_leuko_celltypes & consensus %in% consensus_myeloid_leuko_celltypes ~ "myeloid leukocyte",
      .default = final_label
    )
  ) 
```



### Scenario 2: One of the labels is Unknown

#### Consensus unknown

Exactly identical with unknown consensus:
```{r}
annotation_df <- annotation_df |>
  dplyr::mutate(
    # make sure not to overwrite an existing label!
    final_label = ifelse(
      is.na(final_label) & singler == scanvi & consensus == "Unknown", 
      singler, # arbitrary since they are the same
      final_label
    )
  )
```

Same family with unknown consensus:
```{r}
annotation_df <- annotation_df |>
  dplyr::mutate(
    # make sure not to overwrite an existing label!
    final_label = dplyr::case_when(
      is.na(final_label) & consensus == "Unknown" & singler %in% nbatlas_t_celltypes & scanvi %in% nbatlas_t_celltypes  ~ "T cell",
      is.na(final_label) & consensus == "Unknown" & singler %in% nbatlas_nk_celltypes & scanvi %in% nbatlas_nk_celltypes ~ "natural killer cell",
      is.na(final_label) & consensus == "Unknown" & singler %in% nbatlas_dend_celltypes & scanvi %in% nbatlas_dend_celltypes~ "dendritic cell",
      is.na(final_label) & consensus == "Unknown" & singler %in% nbatlas_mono_celltypes & scanvi %in% nbatlas_mono_celltypes  ~ "monocyte",
      # broadens
      is.na(final_label) & consensus == "Unknown" & singler %in% nbatlas_monophago_celltypes & scanvi %in% nbatlas_monophago_celltypes ~ "mononuclear phagocyte",
      is.na(final_label) & consensus == "Unknown" & singler %in% nbatlas_myeloid_leuko_celltypes & scanvi %in% nbatlas_myeloid_leuko_celltypes ~ "myeloid leukocyte",
      .default = final_label
    )
  ) 
```


#### SingleR unknown

```{r}
annotation_df <- annotation_df |>
  dplyr::mutate(
    # make sure not to overwrite an existing label!
    final_label = dplyr::case_when(
      is.na(final_label) & singler == "Unknown" & scanvi == "B cell" & consensus %in% consensus_b_celltypes ~ "B cell",
      is.na(final_label) & singler == "Unknown" & scanvi == "B cell" & consensus %in% consensus_b_lineage ~ "lymphocyte of B lineage",
      is.na(final_label) & singler == "Unknown" & scanvi == "Endothelial" & consensus %in% consensus_endothelial_celltypes ~ "endothelial cell",
      is.na(final_label) & singler == "Unknown" & scanvi %in% nbatlas_t_celltypes & consensus %in% consensus_t_celltypes ~ "T cell",
      is.na(final_label) & singler == "Unknown" & scanvi %in% nbatlas_nk_celltypes & consensus == "natural killer cell" ~ "natural killer cell",
      is.na(final_label) & singler == "Unknown" & scanvi %in% nbatlas_dend_celltypes & consensus == "dendritic cell" ~ "dendritic cell",
      is.na(final_label) & singler == "Unknown" & scanvi %in% nbatlas_mono_celltypes & consensus == "monocyte" ~ "monocyte",
      is.na(final_label) & singler == "Unknown" & scanvi %in% nbatlas_monophago_celltypes & consensus %in% consensus_monophago_celltypes ~ "mononuclear phagocyte",
      is.na(final_label) & singler == "Unknown" & scanvi %in% nbatlas_myeloid_leuko_celltypes & consensus %in% consensus_myeloid_leuko_celltypes ~ "myeloid leukocyte",
      .default = final_label
    )
  ) 
```



#### scANVI unknown

```{r}
annotation_df <- annotation_df |>
  dplyr::mutate(
    # make sure not to overwrite an existing label!
    final_label = dplyr::case_when(
      is.na(final_label) & scanvi == "Unknown" & singler == "B cell" & consensus %in% consensus_b_celltypes ~ "B cell",
      is.na(final_label) & scanvi == "Unknown" & singler == "B cell" & consensus %in% consensus_b_lineage ~ "lymphocyte of B lineage",
      is.na(final_label) & scanvi == "Unknown" & singler == "Endothelial" & consensus %in% consensus_endothelial_celltypes ~ "endothelial cell",
      is.na(final_label) & scanvi == "Unknown" & singler %in% nbatlas_t_celltypes & consensus %in% consensus_t_celltypes ~ "T cell",
      is.na(final_label) & scanvi == "Unknown" & singler %in% nbatlas_nk_celltypes & consensus == "natural killer cell" ~ "natural killer cell",
      is.na(final_label) & scanvi == "Unknown" & singler %in% nbatlas_dend_celltypes & consensus == "dendritic cell" ~ "dendritic cell",
      is.na(final_label) & scanvi == "Unknown" & singler %in% nbatlas_mono_celltypes & consensus == "monocyte" ~ "monocyte",
      is.na(final_label) & scanvi == "Unknown" & singler %in% nbatlas_monophago_celltypes & consensus %in% consensus_monophago_celltypes ~ "mononuclear phagocyte",
      is.na(final_label) & scanvi == "Unknown" & singler %in% nbatlas_myeloid_leuko_celltypes & consensus %in% consensus_myeloid_leuko_celltypes ~ "myeloid leukocyte",
      .default = final_label
    )
  ) 
```




### What's left?

What fraction of cells have been annotated?

```{r}
sum(!is.na(annotation_df$final_label)) / nrow(annotation_df)
```

What fraction of cells have been annotated per library?

```{r, fig.width = 8, fig.height = 4}
frac_labeled_df <- annotation_df |>
  tidyr::separate(cell_id, into = c("library_id", "barcode"), remove = FALSE) |>
  dplyr::mutate(has_label = !is.na(final_label)) |>
  dplyr::count(library_id, has_label) |>
  tidyr::pivot_wider(
    names_from = has_label, 
    values_from = n
  ) |>
  dplyr::mutate(
    frac_labeled = `TRUE`/(`TRUE`+`FALSE`), 
    total_cells = `TRUE` + `FALSE`
  ) |>
  dplyr::select(library_id, frac_labeled, total_cells)

# get the PDXs for plotting here
frac_labeled_df <- colData(merged_sce) |> 
  as.data.frame() |> 
  dplyr::select(library_id, is_xenograft) |> 
  unique() |>
  dplyr::right_join(frac_labeled_df, by = "library_id")


p1 <- ggplot(frac_labeled_df) + 
  aes(x = frac_labeled) + 
  geom_histogram(bins = 40) +
  labs(x = "Fraction of library labeled")


p2 <- ggplot(frac_labeled_df) + 
  aes(x = total_cells, y = frac_labeled, color = is_xenograft) + 
  geom_point() + 
  labs(
    x = "Total cells in library",
    y = "Fraction of library labeled"
  )


p1 + p2
```


What are the combinations of annotations left that we might be able to nail down further
Note that it's likely a lot of these are tumor.


```{r}
remaining_df <- annotation_df |>
  dplyr::filter(is.na(final_label)) |>
  dplyr::count(consensus, singler, scanvi) |>
  dplyr::arrange(desc(n)) 

remaining_df
```



```{r}
sessionInfo()
```
